{% extends "base.html" %}

{% block title %}Edit Manifest - Fleetman{% endblock %}
{% block nav_manifests %}active{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Edit Manifest: {{ manifest_name }}</h1>
    <a href="/manifests" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Manifests
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" action="/manifests/update" onsubmit="return validateAndCollectFiles()">
            <input type="hidden" name="original_name" value="{{ manifest_name }}">
            
            <div class="mb-3">
                <label class="form-label">Manifest Name</label>
                <input type="text" class="form-control" name="name" value="{{ manifest_name }}" required>
                <small class="form-text text-muted">This name will be used to identify the application and for S3 storage paths.</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Deployment Profile</label>
                <select class="form-select" name="profile" id="profileSelect" required onchange="handleProfileChange()">
                    {% match manifest.profile %}
                    {% when DeploymentProfile::Supervisor %}
                    <option value="supervisor" selected disabled>Supervisor (deprecated)</option>
                    {% when _ %}
                    {% endmatch %}
                    <option value="systemd" {% match manifest.profile %}{% when DeploymentProfile::Systemd %}selected{% when _ %}{% endmatch %}>Systemd</option>
                    <option value="processmaster" {% match manifest.profile %}{% when DeploymentProfile::ProcessMaster %}selected{% when _ %}{% endmatch %}>ProcessMaster</option>
                    <option value="deploy" {% match manifest.profile %}{% when DeploymentProfile::Deploy %}selected{% when _ %}{% endmatch %}>Deploy (files only)</option>
                </select>
                {% match manifest.profile %}
                {% when DeploymentProfile::Supervisor %}
                <small class="form-text text-warning">Supervisor profile is deprecated and cannot be newly created; please migrate to processmaster or systemd.</small>
                {% when _ %}
                {% endmatch %}
            </div>

            <div class="mb-3" id="resourceProfileContainer" style="display: none;">
                <label class="form-label">Resource Profile</label>
                <select class="form-select" name="resource_profile" id="resourceProfileSelect">
                    {% for rp in resource_profiles %}
                    <option value="{{ rp }}" {% if rp.as_str() == manifest.resource_profile.as_str() %}selected{% endif %}>{{ rp }}</option>
                    {% endfor %}
                </select>
                <small class="form-text text-muted">Required for <code>systemd</code> and <code>processmaster</code> manifests.</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Bucket</label>
                <select class="form-select" name="bucket" required>
                    {% if buckets.is_empty() %}
                    <option value="">No buckets configured</option>
                    {% else %}
                    {% for (display_name, bucket_config) in buckets.iter() %}
                    <option value="{{ display_name }}" {% if display_name.as_str() == selected_bucket.as_str() %}selected{% endif %}>
                        {{ display_name }}
                    </option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Service Owner</label>
                    <input type="text" class="form-control" name="service_owner" value="{{ manifest.service_owner }}" placeholder="root" required>
                    <small class="form-text text-muted">Default owner for the service (run-as identity + default ownership for files). Default: <code>root</code>.</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Service Group</label>
                    <input type="text" class="form-control" name="service_group" value="{{ manifest.service_group }}" placeholder="root" required>
                    <small class="form-text text-muted">Default group for the service (run-as identity + default ownership for files). Default: <code>root</code>.</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Service Folder Mode</label>
                    <input type="text" class="form-control" name="service_folder_mode" value="{{ manifest.service_folder_mode }}" placeholder="0700">
                    <small class="form-text text-muted">Octal mode for the deployed service directory. Default: <code>0700</code>.</small>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Service Folder Ownership (optional)</label>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openServiceFolderMetaModal()">
                        Customize Service Folder Ownership
                    </button>
                    <div id="serviceFolderMetaBadges"></div>
                </div>
                <small class="form-text text-muted">
                    If not customized, the service folder ownership defaults to <code>service_owner:service_group</code>.
                </small>
                <input type="hidden" name="service_folder_owner" id="serviceFolderOwnerHidden" value="{{ manifest.service_folder_owner.as_deref().unwrap_or("") }}">
                <input type="hidden" name="service_folder_group" id="serviceFolderGroupHidden" value="{{ manifest.service_folder_group.as_deref().unwrap_or("") }}">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Files Configuration</label>
                <div id="filesList">
                    {% for file in manifest.files %}
                    <div class="file-entry mb-3 p-3 border rounded">
                        <div class="row mb-2">
                            <div class="col-md-8">
                                <label class="form-label small">Path</label>
                                <input type="text" class="form-control form-control-sm file-path-input" value="{{ file.path }}" required oninput="detectFileType(this)">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Type</label>
                                <select class="form-select form-select-sm file-type-select">
                                    <option value="binary" {% match file.file_type %}{% when FileType::Binary %}selected{% when _ %}{% endmatch %}>Binary</option>
                                    <option value="text" {% match file.file_type %}{% when FileType::Text %}selected{% when _ %}{% endmatch %}>Text</option>
                                    <option value="folder" {% match file.file_type %}{% when FileType::Folder %}selected{% when _ %}{% endmatch %}>Folder</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary file-customize-btn" onclick="openFileMetaModal(this)">
                                Customize
                            </button>
                            <div class="file-meta-badges"></div>
                            <input type="hidden" class="file-owner-hidden" value="{{ file.owner.as_deref().unwrap_or("") }}">
                            <input type="hidden" class="file-group-hidden" value="{{ file.group.as_deref().unwrap_or("") }}">
                            <input type="hidden" class="file-mode-hidden" value="{{ file.mode.as_deref().unwrap_or("") }}">
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-file" onclick="removeFile(this)">Remove</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addFileEntry()">+ Add File</button>
                <input type="hidden" name="files" id="filesInput">
                <input type="hidden" name="file_types" id="fileTypesInput">
                <input type="hidden" name="owners" id="ownersInput">
                <input type="hidden" name="groups" id="groupsInput">
                <input type="hidden" name="modes" id="modesInput">
                <small class="form-text text-muted d-block mt-2">Configure each file with path, type, permissions (owner, group, mode)</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Log Collection</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="collect_logs" id="collectLogs" 
                           {% if manifest.collect_logs %}checked{% endif %} onchange="toggleLogFields()">
                    <label class="form-check-label" for="collectLogs">
                        Enable log collection on deployment failure (enabled by default)
                    </label>
                </div>
                <small class="form-text text-muted">When enabled, the agent will collect logs from specified files if deployment fails</small>
            </div>
            
            <div id="logFieldsContainer" style="display: {% if manifest.collect_logs %}block{% else %}none{% endif %};">
                <div class="mb-3">
                    <label class="form-label">Log Files</label>
                    <textarea class="form-control" name="log_files" id="logFiles" rows="4" 
                              placeholder="logs/stdout.log&#10;logs/stderr.log">{% for log_file in manifest.log_files %}{{ log_file }}&#10;{% endfor %}</textarea>
                    <small class="form-text text-muted">One file path per line. Paths are relative to service directory. No absolute paths or escapes allowed. Symbolic links are OK. Default: logs/stdout.log, logs/stderr.log</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Max Lines per Log File</label>
                    <input type="number" class="form-control" name="max_log_lines" value="{{ manifest.max_log_lines }}" min="1" max="10000" placeholder="30">
                    <small class="form-text text-muted">Maximum number of lines to collect from each log file (default: 30)</small>
                </div>
            </div>
            
            <div id="validationAlert" class="alert alert-danger" style="display: none; margin-bottom: 1rem;"></div>
            
            <div class="d-flex justify-content-between">
                <a href="/manifests" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- File Meta Customize Modal -->
<div class="modal fade" id="fileMetaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customize File Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Override (format: <code>user:group:0700</code>)</label>
                    <input type="text" class="form-control" id="fileMetaInput" placeholder="root:root:0700">
                    <div class="form-text">Click the badge “X” to remove customization later.</div>
                </div>
                <div id="fileMetaError" class="alert alert-danger" style="display:none; margin-bottom:0;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyFileMetaFromModal()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Folder Ownership Customize Modal -->
<div class="modal fade" id="serviceFolderMetaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customize Service Folder Ownership</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Override (format: <code>user:group</code>)</label>
                    <input type="text" class="form-control" id="serviceFolderMetaInput" placeholder="root:root">
                    <div class="form-text">Leave blank to cancel. Click the badge “X” to remove customization later.</div>
                </div>
                <div id="serviceFolderMetaError" class="alert alert-danger" style="display:none; margin-bottom:0;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyServiceFolderMetaFromModal()">Apply</button>
            </div>
        </div>
    </div>
</div>

<script>
let __activeFileEntryForMeta = null;

function openServiceFolderMetaModal() {
    const owner = document.getElementById('serviceFolderOwnerHidden')?.value || '';
    const group = document.getElementById('serviceFolderGroupHidden')?.value || '';
    const input = document.getElementById('serviceFolderMetaInput');
    const err = document.getElementById('serviceFolderMetaError');
    err.style.display = 'none';
    input.value = (owner && group) ? `${owner}:${group}` : '';
    const modal = new bootstrap.Modal(document.getElementById('serviceFolderMetaModal'));
    modal.show();
}

function applyServiceFolderMetaFromModal() {
    const raw = (document.getElementById('serviceFolderMetaInput').value || '').trim();
    const err = document.getElementById('serviceFolderMetaError');
    err.style.display = 'none';
    const parts = raw.split(':');
    if (parts.length !== 2) {
        err.textContent = 'Invalid format. Expected: user:group';
        err.style.display = 'block';
        return;
    }
    const user = parts[0].trim();
    const group = parts[1].trim();
    if (!user || /\s/.test(user)) {
        err.textContent = 'Invalid user (no whitespace).';
        err.style.display = 'block';
        return;
    }
    if (!group || /\s/.test(group)) {
        err.textContent = 'Invalid group (no whitespace).';
        err.style.display = 'block';
        return;
    }
    document.getElementById('serviceFolderOwnerHidden').value = user;
    document.getElementById('serviceFolderGroupHidden').value = group;
    renderServiceFolderMetaBadge();
    bootstrap.Modal.getInstance(document.getElementById('serviceFolderMetaModal'))?.hide();
}

function clearServiceFolderMeta() {
    document.getElementById('serviceFolderOwnerHidden').value = '';
    document.getElementById('serviceFolderGroupHidden').value = '';
    renderServiceFolderMetaBadge();
}

function renderServiceFolderMetaBadge() {
    const el = document.getElementById('serviceFolderMetaBadges');
    if (!el) return;
    el.innerHTML = '';
    const owner = document.getElementById('serviceFolderOwnerHidden')?.value || '';
    const group = document.getElementById('serviceFolderGroupHidden')?.value || '';
    if (!owner && !group) return;
    const span = document.createElement('span');
    span.className = 'badge text-bg-secondary';
    span.textContent = `${owner}:${group}`;
    const x = document.createElement('button');
    x.type = 'button';
    x.className = 'btn btn-sm btn-link text-light text-decoration-none ms-2 p-0';
    x.textContent = '×';
    x.onclick = () => clearServiceFolderMeta();
    span.appendChild(x);
    el.appendChild(span);
}

function detectFileType(input) {
    const path = input.value.trim();
    const entry = input.closest('.file-entry');
    const select = entry.querySelector('.file-type-select');
    
    // Auto-detect folder if path ends with '/'
    if (path.endsWith('/')) {
        select.value = 'folder';
    }
}

function getServiceFolderDefaults() {
    const svcOwner = (document.querySelector('input[name="service_owner"]')?.value || 'root').trim() || 'root';
    const svcGroup = (document.querySelector('input[name="service_group"]')?.value || 'root').trim() || 'root';
    const folderOwner = (document.getElementById('serviceFolderOwnerHidden')?.value || '').trim();
    const folderGroup = (document.getElementById('serviceFolderGroupHidden')?.value || '').trim();
    return {
        owner: folderOwner || svcOwner,
        group: folderGroup || svcGroup,
    };
}

function addFileEntry() {
    const filesList = document.getElementById('filesList');
    const newEntry = document.createElement('div');
    newEntry.className = 'file-entry mb-3 p-3 border rounded';
    newEntry.innerHTML = `
        <div class="row mb-2">
            <div class="col-md-8">
                <label class="form-label small">Path</label>
                <input type="text" class="form-control form-control-sm file-path-input" placeholder="file path (e.g. my_binary, config.yaml, logs/)" required oninput="detectFileType(this)">
            </div>
            <div class="col-md-4">
                <label class="form-label small">Type</label>
                <select class="form-select form-select-sm file-type-select">
                    <option value="binary" selected>Binary</option>
                    <option value="text">Text</option>
                    <option value="folder">Folder</option>
                </select>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2 mb-2">
            <button type="button" class="btn btn-sm btn-outline-secondary file-customize-btn" onclick="openFileMetaModal(this)">
                Customize
            </button>
            <div class="file-meta-badges"></div>
            <input type="hidden" class="file-owner-hidden" value="">
            <input type="hidden" class="file-group-hidden" value="">
            <input type="hidden" class="file-mode-hidden" value="">
        </div>
        <button type="button" class="btn btn-sm btn-danger remove-file" onclick="removeFile(this)">Remove</button>
    `;
    filesList.appendChild(newEntry);
}

function openFileMetaModal(btn) {
    __activeFileEntryForMeta = btn.closest('.file-entry');
    const owner = __activeFileEntryForMeta.querySelector('.file-owner-hidden')?.value || '';
    const group = __activeFileEntryForMeta.querySelector('.file-group-hidden')?.value || '';
    const mode = __activeFileEntryForMeta.querySelector('.file-mode-hidden')?.value || '';
    const input = document.getElementById('fileMetaInput');
    const err = document.getElementById('fileMetaError');
    err.style.display = 'none';
    input.value = (owner && group && mode) ? `${owner}:${group}:${mode}` : '';
    const modal = new bootstrap.Modal(document.getElementById('fileMetaModal'));
    modal.show();
}

function applyFileMetaFromModal() {
    if (!__activeFileEntryForMeta) return;
    const raw = (document.getElementById('fileMetaInput').value || '').trim();
    const err = document.getElementById('fileMetaError');
    err.style.display = 'none';
    const parts = raw.split(':');
    if (parts.length !== 3) {
        err.textContent = 'Invalid format. Expected: user:group:0700';
        err.style.display = 'block';
        return;
    }
    const user = parts[0].trim();
    const group = parts[1].trim();
    let mode = parts[2].trim();
    if (!user || /\s/.test(user)) {
        err.textContent = 'Invalid user (no whitespace).';
        err.style.display = 'block';
        return;
    }
    if (!group || /\s/.test(group)) {
        err.textContent = 'Invalid group (no whitespace).';
        err.style.display = 'block';
        return;
    }
    if (!/^[0-7]{3,4}$/.test(mode)) {
        err.textContent = 'Invalid mode. Must be octal like 0700 or 700.';
        err.style.display = 'block';
        return;
    }
    if (mode.length === 3) mode = '0' + mode;
    __activeFileEntryForMeta.querySelector('.file-owner-hidden').value = user;
    __activeFileEntryForMeta.querySelector('.file-group-hidden').value = group;
    __activeFileEntryForMeta.querySelector('.file-mode-hidden').value = mode;
    renderFileMetaBadge(__activeFileEntryForMeta);
    bootstrap.Modal.getInstance(document.getElementById('fileMetaModal'))?.hide();
}

function clearFileMeta(entry) {
    entry.querySelector('.file-owner-hidden').value = '';
    entry.querySelector('.file-group-hidden').value = '';
    entry.querySelector('.file-mode-hidden').value = '';
    renderFileMetaBadge(entry);
}

function renderFileMetaBadge(entry) {
    const badges = entry.querySelector('.file-meta-badges');
    if (!badges) return;
    badges.innerHTML = '';
    const owner = entry.querySelector('.file-owner-hidden')?.value || '';
    const group = entry.querySelector('.file-group-hidden')?.value || '';
    const mode = entry.querySelector('.file-mode-hidden')?.value || '';
    if (!owner && !group && !mode) return;
    const span = document.createElement('span');
    span.className = 'badge text-bg-secondary';
    span.textContent = `${owner}:${group}:${mode}`;
    const x = document.createElement('button');
    x.type = 'button';
    x.className = 'btn btn-sm btn-link text-light text-decoration-none ms-2 p-0';
    x.textContent = '×';
    x.onclick = () => clearFileMeta(entry);
    span.appendChild(x);
    badges.appendChild(span);
}

function removeFile(button) {
    const entries = document.querySelectorAll('.file-entry');
    if (entries.length > 1) {
        button.closest('.file-entry').remove();
    } else {
        alert('At least one file is required');
    }
}

function validateAndCollectFiles() {
    collectFiles();
    
    const alertDiv = document.getElementById('validationAlert');
    
    // Get all file entries
    const entries = document.querySelectorAll('.file-entry');
    
    // Validate all file paths first (applies to all profiles)
    for (const entry of entries) {
        const path = entry.querySelector('.file-path-input').value.trim();
        
        // Check for invalid path patterns
        if (path.startsWith('/')) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> File path cannot be an absolute path. Invalid path: <code>' + path + '</code><br>Use relative paths like <code>folder/file</code> or <code>folder/subfolder/</code>';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        
        if (path.startsWith('../')) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> File path cannot start with parent directory reference. Invalid path: <code>' + path + '</code><br>Use relative paths like <code>folder/file</code> or <code>folder/subfolder/</code>';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        
        if (path.startsWith('./')) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> File path cannot start with current directory reference. Invalid path: <code>' + path + '</code><br>Use relative paths like <code>folder/file</code> or <code>folder/subfolder/</code>';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        
        // Check for path escape patterns anywhere in the path
        if (path.includes('/./')) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> File path cannot contain current directory reference. Invalid path: <code>' + path + '</code><br>Remove <code>/./</code> patterns. Use simple paths like <code>folder/file</code>';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        
        if (path.includes('/../')) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> File path cannot contain parent directory reference. Invalid path: <code>' + path + '</code><br>Remove <code>/../</code> patterns. Use simple paths like <code>folder/file</code>';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
    }
    
    // Get profile
    const profile = document.querySelector('select[name="profile"]').value.toLowerCase();
    
    // Supervisor profile is deprecated; keep validation for legacy manifests.
    if (profile === 'supervisor') {
        let runShFound = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            if (path === 'run.sh') {
                runShFound = true;
            }
        });
        if (!runShFound) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> run.sh is required for supervisor profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
    }

    // Systemd: require app.service (text)
    if (profile === 'systemd') {
        // Also require run.sh (mode is defaulted by the agent unless customized)
        let runShFound = false;
        let runShIsText = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            const type = entry.querySelector('.file-type-select').value;
            if (path === 'run.sh') {
                runShFound = true;
                runShIsText = (type === 'text');
            }
        });
        if (!runShFound) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> run.sh is required for systemd profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        if (!runShIsText) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> run.sh must be a text file.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }

        // Also require logs/ folder
        let logsFound = false;
        let logsIsFolder = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            const type = entry.querySelector('.file-type-select').value;
            if (path === 'logs/') {
                logsFound = true;
                logsIsFolder = (type === 'folder');
            }
        });
        if (!logsFound) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> logs/ folder is required for systemd profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        if (!logsIsFolder) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> logs/ must be a folder entry.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }

        let found = false;
        let isText = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            const type = entry.querySelector('.file-type-select').value;
            if (path === 'app.service') {
                found = true;
                isText = (type === 'text');
            }
        });
        if (!found) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> app.service is required for systemd profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        if (!isText) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> app.service must be a text file.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
    }

    // ProcessMaster: require service.yml (text)
    if (profile === 'processmaster') {
        // Also require run.sh (mode is defaulted by the agent unless customized)
        let runShFound = false;
        let runShIsText = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            const type = entry.querySelector('.file-type-select').value;
            if (path === 'run.sh') {
                runShFound = true;
                runShIsText = (type === 'text');
            }
        });
        if (!runShFound) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> run.sh is required for processmaster profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        if (!runShIsText) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> run.sh must be a text file.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }

        // Also require logs/ folder
        let logsFound = false;
        let logsIsFolder = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            const type = entry.querySelector('.file-type-select').value;
            if (path === 'logs/') {
                logsFound = true;
                logsIsFolder = (type === 'folder');
            }
        });
        if (!logsFound) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> logs/ folder is required for processmaster profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        if (!logsIsFolder) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> logs/ must be a folder entry.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }

        let found = false;
        let isText = false;
        entries.forEach(entry => {
            const path = entry.querySelector('.file-path-input').value.trim();
            const type = entry.querySelector('.file-type-select').value;
            if (path === 'service.yml') {
                found = true;
                isText = (type === 'text');
            }
        });
        if (!found) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> service.yml is required for processmaster profile.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        if (!isText) {
            alertDiv.innerHTML = '<strong>Validation Error:</strong> service.yml must be a text file.';
            alertDiv.style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
    }
    
    // Validation passed
    alertDiv.style.display = 'none';
    return true;
}

function collectFiles() {
    const entries = document.querySelectorAll('.file-entry');
    const paths = [];
    const types = [];
    const owners = [];
    const groups = [];
    const modes = [];
    
    entries.forEach(entry => {
        const path = entry.querySelector('.file-path-input').value.trim();
        const type = entry.querySelector('.file-type-select').value;
        const owner = entry.querySelector('.file-owner-hidden')?.value.trim() || '';
        const group = entry.querySelector('.file-group-hidden')?.value.trim() || '';
        const mode = entry.querySelector('.file-mode-hidden')?.value.trim() || '';
        
        if (path) {
            paths.push(path);
            types.push(type);
            owners.push(owner);
            groups.push(group);
            modes.push(mode);
        }
    });
    
    document.getElementById('filesInput').value = paths.join('\n');
    document.getElementById('fileTypesInput').value = types.join('\n');
    document.getElementById('ownersInput').value = owners.join('\n');
    document.getElementById('groupsInput').value = groups.join('\n');
    document.getElementById('modesInput').value = modes.join('\n');
}

function handleProfileChange() {
    const profile = document.getElementById('profileSelect').value;
    const rpContainer = document.getElementById('resourceProfileContainer');
    const rpSelect = document.getElementById('resourceProfileSelect');

    if (profile === 'systemd' || profile === 'processmaster') {
        rpContainer.style.display = 'block';
        rpSelect.required = true;
    } else {
        rpContainer.style.display = 'none';
        rpSelect.required = false;
    }
}

function toggleLogFields() {
    const checkbox = document.getElementById('collectLogs');
    const container = document.getElementById('logFieldsContainer');
    container.style.display = checkbox.checked ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    handleProfileChange();
    renderServiceFolderMetaBadge();
    document.querySelectorAll('.file-entry').forEach(e => renderFileMetaBadge(e));
});
</script>
{% endblock %}

