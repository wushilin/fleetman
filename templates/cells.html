{% extends "base.html" %}

{% block title %}Cell Management - Fleetman{% endblock %}

{% block nav_cells %}active{% endblock %}

{% block content %}
<h1>Cell Management</h1>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Configured Cells</h5>
        <div class="d-flex gap-2">
            <a href="/cells" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </a>
            <a href="/cells/add" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Add Cell
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if cells.is_empty() %}
        <p class="text-muted">No cells configured yet.</p>
        {% else %}
        <div class="mb-3 row">
            <div class="col-md-4">
                <label for="filterCellId" class="form-label small">Filter by Cell ID:</label>
                <input type="text" class="form-control form-control-sm" id="filterCellId" 
                       placeholder="Search cell ID..." onkeyup="filterCells()">
            </div>
            <div class="col-md-3">
                <label for="filterManifest" class="form-label small">Filter by Manifest:</label>
                <input type="text" class="form-control form-control-sm" id="filterManifest" 
                       placeholder="Search manifest..." onkeyup="filterCells()">
            </div>
            <div class="col-md-3">
                <label for="filterStatus" class="form-label small">Filter by Status:</label>
                <select class="form-select form-select-sm" id="filterStatus" onchange="filterCells()">
                    <option value="">All</option>
                    <option value="success">Success</option>
                    <option value="pending">Deploying</option>
                    <option value="failed">Failed</option>
                    <option value="unknown">Unknown</option>
                    <option value="stale">Agent Stale</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-sm btn-secondary" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped" id="cellsTable">
                <thead>
                    <tr>
                        <th style="cursor: pointer;" onclick="sortTable(0)">
                            Cell ID <span id="sort-0" class="sort-indicator">⇅</span>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(1)">
                            Manifest <span id="sort-1" class="sort-indicator">⇅</span>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(2)">
                            Version (Desired → Running) <span id="sort-2" class="sort-indicator">⇅</span>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(3)">
                            Status <span id="sort-3" class="sort-indicator">⇅</span>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cell_info in cells %}
                    <tr>
                        <td><strong>{{ cell_info.cell_key }}</strong></td>
                        <td>{{ cell_info.cell.manifest }}</td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <!-- Desired Version -->
                                {% match cell_info.status.desired_version %}
                                {% when Some with (v) %}
                                    {% match cell_info.status.desired_timestamp %}
                                    {% when Some with (ts) %}
                                        <span class="badge bg-primary" 
                                              title="Desired version published at: {{ ts }}" 
                                              style="cursor: help;">{{ v }}</span>
                                    {% when None %}
                                        <span class="badge bg-primary">{{ v }}</span>
                                    {% endmatch %}
                                {% when None %}
                                    <span class="text-muted">-</span>
                                {% endmatch %}
                                
                                <span class="text-muted">→</span>
                                
                                <!-- Running Version -->
                                {% match cell_info.status.running_version %}
                                {% when Some with (v) %}
                                    {% match cell_info.status.applied_at %}
                                    {% when Some with (ts) %}
                                        <span class="badge bg-success" 
                                              title="Running version applied at: {{ ts }}" 
                                              style="cursor: help;">{{ v }}</span>
                                    {% when None %}
                                        <span class="badge bg-success">{{ v }}</span>
                                    {% endmatch %}
                                {% when None %}
                                    <span class="text-muted">-</span>
                                {% endmatch %}
                            </div>
                        </td>
                        <td>
                            {% if cell_info.status.status == "success" %}
                                <span class="badge bg-success">✓ Success</span>
                            {% else if cell_info.status.status == "pending" %}
                                <span class="badge bg-info">⏳ Deploying</span>
                                {% match cell_info.status.error %}
                                {% when Some with (msg) %}
                                    <small class="text-muted ms-1">{{ msg }}</small>
                                {% when None %}
                                {% endmatch %}
                            {% else if cell_info.status.status == "failed" %}
                                <span class="badge bg-danger">✗ Failed</span>
                                <a href="/cells/{{ cell_info.cell.node_id }}/{{ cell_info.cell.cell_id }}/status" 
                                   class="btn btn-sm btn-outline-danger" target="_blank">
                                    View Error
                                </a>
                            {% else %}
                                <span class="badge bg-secondary">Unknown</span>
                            {% endif %}
                            {% if cell_info.status.agent_stale %}
                                <span class="badge bg-warning text-dark ms-1" 
                                      title="Trigger is >2 min newer than status">
                                    ⚠ Agent may be down
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/cells/{{ cell_info.cell.node_id }}/{{ cell_info.cell.cell_id }}/overrides" 
                               class="btn btn-sm btn-primary">Overrides</a>
                            <a href="/cells/{{ cell_info.cell.node_id }}/{{ cell_info.cell.cell_id }}/versions" 
                               class="btn btn-sm btn-info">Versions</a>
                            {% match cell_info.manifest_bucket %}
                            {% when Some with (manifest_bucket) %}
                            <button class="btn btn-sm btn-success" 
                                    onclick="showPublishModal('{{ cell_info.cell.node_id }}', '{{ cell_info.cell.cell_id }}', '{{ cell_info.manifest_name }}', '{{ manifest_bucket }}')">
                                Publish
                            </button>
                            {% when None %}
                            <button class="btn btn-sm btn-secondary" disabled title="Manifest bucket not found">
                                Publish
                            </button>
                            {% endmatch %}
                            <form method="post" action="/cells/delete" style="display:inline;">
                                <input type="hidden" name="cell_key" value="{{ cell_info.cell_key }}">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Are you sure you want to delete this cell?');">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- Publish Deployment Modal -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Publish Deployment to Cell</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="publishForm" onsubmit="return handleSinglePublishSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="publish_app_name" name="app_name">
                    <input type="hidden" id="publish_bucket" name="bucket">
                    <input type="hidden" id="publish_node_id" value="">
                    <input type="hidden" id="publish_cell_id" value="">
                    
                    <div class="mb-3">
                        <label class="form-label">Application</label>
                        <div class="form-control-plaintext" id="display_app_name"><strong>-</strong></div>
                    </div>
                    <div class="mb-3">
                        <label for="publish_version" class="form-label">Version</label>
                        <select class="form-select" id="publish_version" name="version" required disabled>
                            <option value="">Loading versions...</option>
                        </select>
                        <div class="form-text" id="version_loading" style="display:none;">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                            Loading versions...
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> This will copy all files from the deployment version 
                        to the cell's <code>versions/</code> folder and update the <code>trigger.json</code> file.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Publish</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Single Publish Pre-check Modal -->
<div class="modal fade" id="singlePublishPrecheckModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Version Already Exists</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">
                    This version already exists in this cell. Publishing will <strong>not rebuild</strong> the per-cell snapshot.
                </p>
                <div class="alert alert-warning mb-0">
                    If you changed overrides and need a rebuild, delete the cell version first (or publish a new version).
                    Continuing will only <strong>re-trigger</strong> the agent to re-apply/restart the existing snapshot.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="singlePrecheckConfirmBtn">
                    Continue (re-trigger)
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let publishModal;
let singlePublishPrecheckModal;
let singleBypassPrecheck = false;

document.addEventListener('DOMContentLoaded', function() {
    publishModal = new bootstrap.Modal(document.getElementById('publishModal'));
    singlePublishPrecheckModal = new bootstrap.Modal(document.getElementById('singlePublishPrecheckModal'));
});

async function loadVersions(appName, bucket) {
    const versionSelect = document.getElementById('publish_version');
    const versionLoading = document.getElementById('version_loading');
    
    // Show loading indicator
    versionLoading.style.display = 'block';
    versionSelect.disabled = true;
    versionSelect.innerHTML = '<option value="">Loading...</option>';
    
    try {
        const response = await fetch(`/api/app-versions?manifest=${encodeURIComponent(appName)}&bucket=${encodeURIComponent(bucket)}`);
        const data = await response.json();
        
        versionLoading.style.display = 'none';
        
        if (data.versions && data.versions.length > 0) {
            versionSelect.innerHTML = '<option value="">Select a version...</option>';
            data.versions.forEach(versionInfo => {
                const option = document.createElement('option');
                option.value = versionInfo.version;
                option.textContent = versionInfo.version;
                versionSelect.appendChild(option);
            });
            versionSelect.disabled = false;
        } else {
            versionSelect.innerHTML = '<option value="">No finalized versions available</option>';
            versionSelect.disabled = true;
        }
    } catch (error) {
        console.error('Error loading versions:', error);
        versionLoading.style.display = 'none';
        versionSelect.innerHTML = '<option value="">Error loading versions</option>';
        versionSelect.disabled = true;
    }
}

function showPublishModal(nodeId, cellId, manifestName, bucket) {
    document.getElementById('publish_app_name').value = manifestName;
    document.getElementById('publish_bucket').value = bucket;
    document.getElementById('display_app_name').innerHTML = `<strong>${manifestName}</strong>`;
    document.getElementById('publishForm').action = `/cells/${nodeId}/${cellId}/publish`;
    document.getElementById('publish_node_id').value = nodeId;
    document.getElementById('publish_cell_id').value = cellId;
    
    // Reset and load versions
    document.getElementById('publish_version').innerHTML = '<option value="">Loading versions...</option>';
    document.getElementById('publish_version').disabled = true;
    
    publishModal.show();
    
    // Load versions for this manifest
    loadVersions(manifestName, bucket);
}

async function handleSinglePublishSubmit(event) {
    if (singleBypassPrecheck) {
        singleBypassPrecheck = false;
        return true;
    }

    event.preventDefault();
    const nodeId = document.getElementById('publish_node_id').value;
    const cellId = document.getElementById('publish_cell_id').value;
    const version = document.getElementById('publish_version').value;
    if (!version) {
        return false;
    }

    try {
        const resp = await fetch(`/api/cell-version-exists?node_id=${encodeURIComponent(nodeId)}&cell_id=${encodeURIComponent(cellId)}&version=${encodeURIComponent(version)}`);
        const data = await resp.json();
        if (!data.exists) {
            singleBypassPrecheck = true;
            document.getElementById('publishForm').submit();
            return false;
        }

        // Show modal confirmation
        document.getElementById('singlePrecheckConfirmBtn').onclick = () => {
            singlePublishPrecheckModal.hide();
            singleBypassPrecheck = true;
            document.getElementById('publishForm').submit();
        };
        singlePublishPrecheckModal.show();
        return false;
    } catch (e) {
        if (confirm('Pre-check failed. Continue publishing anyway?')) {
            singleBypassPrecheck = true;
            document.getElementById('publishForm').submit();
        }
        return false;
    }
}

// Format timestamps in tooltips on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[title*="at: "]').forEach(function(element) {
        const title = element.getAttribute('title');
        const match = title.match(/at: (\d+)/);
        if (match) {
            const timestamp = parseInt(match[1]);
            const date = new Date(timestamp * 1000);
            const formatted = date.toLocaleString();
            const newTitle = title.replace(/at: \d+/, `at: ${formatted}`);
            element.setAttribute('title', newTitle);
        }
    });
});

// Filter cells by cell ID, manifest, and status
function filterCells() {
    const cellIdFilter = document.getElementById('filterCellId').value.toLowerCase();
    const manifestFilter = document.getElementById('filterManifest').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value.toLowerCase();
    const table = document.getElementById('cellsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cellIdText = row.cells[0].textContent.toLowerCase();
        const manifestText = row.cells[1].textContent.toLowerCase();
        const statusCell = row.cells[3];
        
        // Check cell ID match (fuzzy search)
        const cellIdMatch = cellIdText.includes(cellIdFilter);
        
        // Check manifest match (fuzzy search)
        const manifestMatch = manifestText.includes(manifestFilter);
        
        // Check status match
        let statusMatch = true;
        if (statusFilter) {
            if (statusFilter === 'success') {
                statusMatch = statusCell.textContent.includes('Success');
            } else if (statusFilter === 'pending') {
                statusMatch = statusCell.textContent.includes('Deploying');
            } else if (statusFilter === 'failed') {
                statusMatch = statusCell.textContent.includes('Failed');
            } else if (statusFilter === 'unknown') {
                statusMatch = statusCell.textContent.includes('Unknown');
            } else if (statusFilter === 'stale') {
                statusMatch = statusCell.textContent.includes('Agent may be down');
            }
        }
        
        // Show row if all filters match
        if (cellIdMatch && manifestMatch && statusMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Update visible count if you want to show it
    console.log(`Showing ${visibleCount} of ${rows.length} cells`);
}

// Clear all filters
function clearFilters() {
    document.getElementById('filterCellId').value = '';
    document.getElementById('filterManifest').value = '';
    document.getElementById('filterStatus').value = '';
    filterCells();
}

// Sort table by column
let sortDirections = [0, 0, 0, 0]; // 0 = unsorted, 1 = asc, -1 = desc

function sortTable(columnIndex) {
    const table = document.getElementById('cellsTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Toggle sort direction
    sortDirections[columnIndex] = sortDirections[columnIndex] === 1 ? -1 : 1;
    const direction = sortDirections[columnIndex];
    
    // Reset other column indicators
    for (let i = 0; i < 4; i++) {
        const indicator = document.getElementById(`sort-${i}`);
        if (i === columnIndex) {
            indicator.textContent = direction === 1 ? '▲' : '▼';
        } else {
            indicator.textContent = '⇅';
        }
    }
    
    // Sort rows
    rows.sort((a, b) => {
        let aValue, bValue;
        
        if (columnIndex === 2) {
            // For version column, extract desired version (before →)
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();
            
            // Extract version before →
            const aMatch = aText.match(/([^\s→]+)/);
            const bMatch = bText.match(/([^\s→]+)/);
            
            aValue = aMatch ? aMatch[1].trim() : '';
            bValue = bMatch ? bMatch[1].trim() : '';
            
            // Handle "-" as empty
            if (aValue === '-') aValue = '';
            if (bValue === '-') bValue = '';
            
            // Try semantic version sort
            if (aValue.startsWith('v') && bValue.startsWith('v')) {
                const aParts = aValue.substring(1).split('.').map(x => parseInt(x) || 0);
                const bParts = bValue.substring(1).split('.').map(x => parseInt(x) || 0);
                
                for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                    const aPart = aParts[i] || 0;
                    const bPart = bParts[i] || 0;
                    if (aPart !== bPart) {
                        return (aPart - bPart) * direction;
                    }
                }
                return 0;
            }
        } else if (columnIndex === 3) {
            // For status column, extract status badge text
            const aText = a.cells[columnIndex].querySelector('.badge')?.textContent.trim() || '';
            const bText = b.cells[columnIndex].querySelector('.badge')?.textContent.trim() || '';
            aValue = aText;
            bValue = bText;
        } else {
            // For other columns, use text content
            aValue = a.cells[columnIndex].textContent.trim();
            bValue = b.cells[columnIndex].textContent.trim();
        }
        
        // String comparison
        if (aValue < bValue) return -1 * direction;
        if (aValue > bValue) return 1 * direction;
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}
</script>

<style>
.badge {
    font-size: 0.85rem;
}

.sort-indicator {
    font-size: 0.8rem;
    color: #6c757d;
    margin-left: 0.25rem;
}

thead th {
    user-select: none;
}

thead th:hover {
    background-color: rgba(0, 0, 0, 0.03);
}
</style>

{% endblock %}

