{% extends "base.html" %}

{% block title %}{{ manifest_name }} {{ version }} - Fleetman{% endblock %}
{% block nav_deployments %}active{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Deployment: {{ manifest_name }} - {{ version }}</h1>
    <a href="/deployments" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Deployments
    </a>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Deployment Details</h5>
    </div>
    <div class="card-body">
        {% if is_finalized %}
        <div class="alert alert-info">
            <i class="bi bi-shield-lock"></i> <strong>Sealed Deployment:</strong> This deployment has been sealed{% match finalized_at %}{% when Some with (ts) %} on {{ ts }}{% when None %}{% endmatch %}.
            <br>Sealed deployments are immutable. Create a new version if you need to make changes.
            <br><small class="text-muted"><i class="bi bi-info-circle"></i> Showing files from the manifest snapshot at seal time.</small>
        </div>
        {% else %}
        <div class="alert alert-success">
            <i class="bi bi-pencil-square"></i> <strong>Draft Mode:</strong> This deployment is still being edited.
            <br>You can upload, edit, or delete files. Click "Seal Deployment" when ready to finalize.
        </div>
        {% if is_edit_mode %}
        {% else %}
        {% match last_version %}
        {% when Some with (lv) %}
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> Found previous version: <strong>{{ lv }}</strong>
            <br>Files have been cloned to the new version.
        </div>
        {% when None %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No previous version found. This is the initial deployment.
        </div>
        {% endmatch %}
        {% endif %}
        {% endif %}

        <h5 class="mt-4">Manifest Files</h5>
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-earmark-text"></i> Files Status
            </div>
            <div class="card-body">
                <div id="manifestFilesList">Loading...</div>
            </div>
        </div>

        {% if !is_finalized %}
        <div class="mt-4">
            <div id="deploymentStatus" class="alert alert-info mb-3">
                Checking deployment status...
            </div>
            <form method="post" action="/deployments/finish" style="display:inline;" onsubmit="return confirm('Are you sure you want to finalize this deployment? It will become immutable.');">
                <input type="hidden" name="manifest" value="{{ manifest_name }}">
                <input type="hidden" name="version" value="{{ version }}">
                <button id="finishButton" type="submit" class="btn btn-success" disabled>
                    <i class="bi bi-shield-lock"></i> Seal Deployment
                </button>
            </form>
            <a href="/deployments" class="btn btn-secondary ms-2">
                <i class="bi bi-arrow-left"></i> Back (Save as Draft)
            </a>
        </div>
        {% else %}
        <div class="mt-4">
            {% if is_finalized %}
            <button type="button" class="btn btn-primary" onclick="showBulkPublishModal()">
                <i class="bi bi-rocket-takeoff"></i> Bulk Publish to Cells
            </button>
            {% endif %}
            <a href="/deployments" class="btn btn-secondary {% if is_finalized %}ms-2{% endif %}">
                <i class="bi bi-arrow-left"></i> Back to Deployments
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const manifestName = '{{ manifest_name }}';
    const versionName = '{{ version }}';
    
    let currentFileStatuses = [];
    let serviceTemplateInfo = null;
    
    // Helper function to format bytes
    function formatBytes(bytes) {
        if (bytes === null || bytes === undefined) return 'N/A';
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Helper function to format timestamp
    function formatTimestamp(timestamp) {
        if (!timestamp || timestamp === 'Unknown') return 'N/A';
        try {
            let date;
            // Check if timestamp is a number (Unix timestamp in seconds) or string (ISO DateTime)
            if (typeof timestamp === 'number') {
                // Unix timestamp in seconds - convert to milliseconds
                date = new Date(timestamp * 1000);
            } else if (typeof timestamp === 'string') {
                // ISO DateTime string - parse directly
                date = new Date(timestamp);
            } else {
                return 'N/A';
            }
            
            // Check if date is valid
            if (isNaN(date.getTime())) {
                return 'N/A';
            }
            
            return date.toLocaleString();
        } catch (e) {
            return 'N/A';
        }
    }
    
    // Auto-refresh manifest files status
    function loadManifestFiles() {
        fetch(`/deployments/file-status?manifest=${manifestName}&version=${versionName}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('manifestFilesList').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                // Store file statuses for validation
                currentFileStatuses = data.files;
                updateDeploymentStatus();
                
                let html = '<div class="table-responsive"><table class="table table-hover">';
                html += '<thead><tr><th>File</th><th>Type</th><th>Size</th><th>Last Modified</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                data.files.forEach(file => {
                    html += '<tr>';
                    html += `<td><code>${file.path}</code></td>`;
                    
                    // File type badge with different color for folders
                    const typeColor = file.file_type === 'text' ? 'info' : (file.file_type === 'folder' ? 'warning' : 'secondary');
                    html += `<td><span class="badge bg-${typeColor}">${file.file_type}</span></td>`;
                    
                    // Size and Last Modified
                    html += `<td>${formatBytes(file.size)}</td>`;
                    html += `<td><small>${formatTimestamp(file.last_modified)}</small></td>`;
                    
                    // Status - folders don't need uploading
                    if (file.file_type === 'folder') {
                        html += `<td><span class="badge bg-secondary">Not required</span></td>`;
                        html += '<td><em class="text-muted">No action needed</em></td>';
                    } else {
                        html += `<td><span class="badge bg-${file.exists ? 'success' : 'warning'}">${file.exists ? 'Uploaded' : 'Not uploaded'}</span></td>`;
                        html += '<td>';
                        
                        {% if !is_finalized %}
                        if (file.exists) {
                            // Show edit button only for text files
                            if (file.file_type === 'text') {
                                html += `<a href="/deployments/edit?manifest=${manifestName}&version=${versionName}&file_path=${encodeURIComponent(file.path)}&edit=true" 
                                           class="btn btn-sm btn-primary me-1"><i class="bi bi-pencil"></i> Edit</a>`;
                            }
                            // Show download button for all files
                            html += `<a href="/deployments/download?manifest=${manifestName}&version=${versionName}&file_path=${encodeURIComponent(file.path)}" 
                                       class="btn btn-sm btn-secondary me-1"><i class="bi bi-download"></i> Download</a>`;
                            // Show delete button
                            html += `<form method="post" action="/deployments/delete" style="display:inline;" 
                                          onsubmit="return confirm('Delete ${file.path}?');">
                                        <input type="hidden" name="manifest" value="${manifestName}">
                                        <input type="hidden" name="version" value="${versionName}">
                                        <input type="hidden" name="file_path" value="${file.path}">
                                        <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i> Delete</button>
                                     </form>`;
                        } else {
                            // Show upload and copy from staging buttons
                            html += `<button class="btn btn-sm btn-success me-1" onclick="showUploadModal('${file.path}')">
                                        <i class="bi bi-upload"></i> Upload
                                     </button>`;
                            html += `<button class="btn btn-sm btn-info" onclick="showStagingModal('${file.path}')">
                                        <i class="bi bi-folder-symlink"></i> Copy from Staging
                                     </button>`;

                            // Generate templates (run.sh + service files)
                            if (file.file_type === 'text' && (file.path === 'run.sh' || (serviceTemplateInfo && file.path === serviceTemplateInfo.target_path))) {
                                html += `<button class="btn btn-sm btn-warning ms-1" onclick="generateFile('${file.path}')">
                                            <i class="bi bi-magic"></i> Generate
                                         </button>`;
                            }
                        }
                        {% else %}
                        if (file.exists) {
                            // For sealed deployments, show View/Download buttons
                            if (file.file_type === 'text') {
                                // Text files: View + Download
                                html += `<a href="/deployments/edit?manifest=${manifestName}&version=${versionName}&file_path=${encodeURIComponent(file.path)}&edit=true" 
                                           class="btn btn-sm btn-info me-1" target="_blank"><i class="bi bi-eye"></i> View</a>`;
                                html += `<a href="/deployments/download?manifest=${manifestName}&version=${versionName}&file_path=${encodeURIComponent(file.path)}" 
                                           class="btn btn-sm btn-secondary"><i class="bi bi-download"></i> Download</a>`;
                            } else {
                                // Binary files: Download only
                                html += `<a href="/deployments/download?manifest=${manifestName}&version=${versionName}&file_path=${encodeURIComponent(file.path)}" 
                                           class="btn btn-sm btn-secondary"><i class="bi bi-download"></i> Download</a>`;
                            }
                        } else {
                            html += '<span class="text-muted"><i class="bi bi-lock"></i> File not uploaded</span>';
                        }
                        {% endif %}
                        
                        html += '</td>';
                    }
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                document.getElementById('manifestFilesList').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('manifestFilesList').innerHTML = 
                    '<div class="alert alert-danger">Failed to load files status</div>';
            });
    }

    function loadServiceTemplateInfo() {
        fetch(`/api/service-template?manifest=${encodeURIComponent(manifestName)}`)
            .then(r => r.json())
            .then(data => {
                if (data && data.ok) {
                    serviceTemplateInfo = data;
                } else {
                    serviceTemplateInfo = null;
                }
            })
            .catch(_ => { serviceTemplateInfo = null; });
    }

    function generateFile(filePath) {
        if (!serviceTemplateInfo || !serviceTemplateInfo.ok) {
            // run.sh does not need serviceTemplateInfo
            if (filePath !== 'run.sh') {
                alert('Service template is not available for this manifest.');
                return;
            }
        }
        fetch('/deployments/generate-service-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                manifest: manifestName,
                version: versionName,
                file_path: filePath,
                values: {},
            }),
        })
        .then(r => r.json())
        .then(resp => {
            if (!resp.ok) {
                alert(`Generate failed: ${resp.error || 'unknown error'}`);
            } else {
                loadManifestFiles();
            }
        })
        .catch(e => alert(`Generate failed: ${e}`));
    }

    function showUploadModal(filePath) {
        document.getElementById('uploadFilePath').value = filePath;
        document.getElementById('uploadFileLabel').textContent = `Upload: ${filePath}`;
        new bootstrap.Modal(document.getElementById('uploadModal')).show();
    }
    
    let currentStagingDestPath = '';
    let currentStagingPath = '';
    let stagingBucket = '';
    let stagingItems = [];
    let stagingSortField = 'name';
    let stagingSortAsc = true;
    
    function showStagingModal(filePath) {
        currentStagingDestPath = filePath;
        currentStagingPath = '';
        stagingSortField = 'name';
        stagingSortAsc = true;
        
        // Get bucket from manifest
        fetch(`/api/manifest-versions?manifest={{ manifest_name }}`)
            .then(r => r.json())
            .then(data => {
                if (data.bucket) {
                    stagingBucket = data.bucket;
                    document.getElementById('stagingDestPath').textContent = filePath;
                    document.getElementById('currentStagingPath').value = '';
                    browseStagingFolder('');
                    new bootstrap.Modal(document.getElementById('stagingModal')).show();
                }
            });
    }
    
    function browseStagingFolder(path) {
        currentStagingPath = path;
        document.getElementById('currentStagingPath').value = path || '(root)';
        document.getElementById('stagingUpBtn').disabled = !path;
        
        // Clear search input when navigating folders
        const searchInput = document.getElementById('stagingSearchInput');
        if (searchInput) {
            searchInput.value = '';
        }
        
        const url = `/deployments/staging/browse?bucket=${encodeURIComponent(stagingBucket)}&path=${encodeURIComponent(path)}`;
        
        fetch(url)
            .then(r => r.json())
            .then(items => {
                stagingItems = items;
                renderStagingItems();
            })
            .catch(err => {
                document.getElementById('stagingFilesList').innerHTML = 
                    '<div class="alert alert-danger">Failed to load staging files</div>';
            });
    }
    
    function sortStagingBy(field) {
        if (stagingSortField === field) {
            stagingSortAsc = !stagingSortAsc;
        } else {
            stagingSortField = field;
            stagingSortAsc = true;
        }
        renderStagingItems();
    }
    
    function renderStagingItems() {
        const list = document.getElementById('stagingFilesList');
        if (stagingItems.length === 0) {
            list.innerHTML = '<div class="alert alert-info">No files or folders found in staging.</div>';
            return;
        }
        
        // Filter items based on search input
        const searchTerm = (document.getElementById('stagingSearchInput')?.value || '').toLowerCase().trim();
        let filtered = stagingItems;
        if (searchTerm) {
            filtered = stagingItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
        }
        
        if (filtered.length === 0) {
            list.innerHTML = '<div class="alert alert-warning">No files or folders match your filter.</div>';
            return;
        }
        
        // Sort items
        const sorted = [...filtered].sort((a, b) => {
            // Folders always come first
            if (a.is_folder !== b.is_folder) {
                return a.is_folder ? -1 : 1;
            }
            
            let aVal, bVal;
            if (stagingSortField === 'name') {
                aVal = a.name.toLowerCase();
                bVal = b.name.toLowerCase();
            } else if (stagingSortField === 'size') {
                aVal = a.size || 0;
                bVal = b.size || 0;
            } else if (stagingSortField === 'modified') {
                aVal = a.last_modified || 0;
                bVal = b.last_modified || 0;
            }
            
            if (aVal < bVal) return stagingSortAsc ? -1 : 1;
            if (aVal > bVal) return stagingSortAsc ? 1 : -1;
            return 0;
        });
        
        // Render as table
        let html = `
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th style="cursor: pointer;" onclick="sortStagingBy('name')">
                            Name ${stagingSortField === 'name' ? (stagingSortAsc ? '▲' : '▼') : ''}
                        </th>
                        <th style="cursor: pointer;" onclick="sortStagingBy('size')">
                            Size ${stagingSortField === 'size' ? (stagingSortAsc ? '▲' : '▼') : ''}
                        </th>
                        <th style="cursor: pointer;" onclick="sortStagingBy('modified')">
                            Modified ${stagingSortField === 'modified' ? (stagingSortAsc ? '▲' : '▼') : ''}
                        </th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        sorted.forEach(item => {
            const sizeStr = item.is_folder ? '-' : (item.size ? formatBytes(item.size) : 'N/A');
            const modifiedStr = item.is_folder ? '-' : (item.last_modified ? formatTimestamp(item.last_modified) : 'N/A');
            const icon = item.is_folder ? 'bi-folder' : 'bi-file-earmark';
            const nameDisplay = item.is_folder ? `${item.name}/` : item.name;
            const clickHandler = item.is_folder 
                ? `browseStagingFolder('${item.path}')`
                : `selectStagingFile('${item.path}')`;
            
            html += `
                <tr style="cursor: pointer;" onclick="${clickHandler}">
                    <td><i class="bi ${icon}"></i> ${nameDisplay}</td>
                    <td><small>${sizeStr}</small></td>
                    <td><small>${modifiedStr}</small></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        list.innerHTML = html;
    }
    
    function navigateUpStaging() {
        if (!currentStagingPath) return;
        
        const parts = currentStagingPath.split('/');
        parts.pop();
        const parentPath = parts.join('/');
        browseStagingFolder(parentPath);
    }
    
    function refreshStaging() {
        browseStagingFolder(currentStagingPath);
    }
    
    function selectStagingFile(stagingPath) {
        if (confirm(`Copy ${stagingPath} to ${currentStagingDestPath}?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/deployments/staging/copy';
            
            const fields = {
                manifest: '{{ manifest_name }}',
                version: '{{ version }}',
                staging_path: stagingPath,
                remote_path: currentStagingDestPath
            };
            
            for (const [key, value] of Object.entries(fields)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    function formatBytes(bytes) {
        if (bytes === null || bytes === undefined) return 'N/A';
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function updateDeploymentStatus() {
        // Only update if these elements exist (they don't exist for read-only versions)
        const statusDiv = document.getElementById('deploymentStatus');
        const finishButton = document.getElementById('finishButton');
        
        if (!statusDiv || !finishButton) {
            return; // Skip for read-only versions
        }
        
        // Check if all required files (text/binary) are uploaded
        const requiredFiles = currentFileStatuses.filter(f => f.file_type !== 'folder');
        const missingFiles = requiredFiles.filter(f => !f.exists);
        
        if (requiredFiles.length === 0) {
            statusDiv.className = 'alert alert-warning mb-3';
            statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> No files defined in manifest.';
            finishButton.disabled = true;
        } else if (missingFiles.length === 0) {
            // All files uploaded. Seal will perform unresolved-placeholder checks server-side.
            statusDiv.className = 'alert alert-success mb-3';
            statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> All required files uploaded (${requiredFiles.length}/${requiredFiles.length}). Ready to seal!`;
            finishButton.disabled = false;
        } else {
            statusDiv.className = 'alert alert-warning mb-3';
            statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${missingFiles.length} required file(s) not uploaded yet. Progress: ${requiredFiles.length - missingFiles.length}/${requiredFiles.length}`;
            statusDiv.innerHTML += '<br><small>Missing: ' + missingFiles.map(f => f.path).join(', ') + '</small>';
            finishButton.disabled = true;
        }
    }
    
    // finishDeployment removed - now handled by form submission
    
    loadServiceTemplateInfo();
    loadManifestFiles();
    setInterval(loadManifestFiles, 5000); // Refresh every 5 seconds
</script>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/deployments/upload" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadFileLabel">Upload File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="manifest" value="{{ manifest_name }}">
                    <input type="hidden" name="version" value="{{ version }}">
                    <input type="hidden" name="remote_path" id="uploadFilePath">
                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" class="form-control" name="file" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-upload"></i> Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Copy from Staging Modal -->
<div class="modal fade" id="stagingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Copy from Staging</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Destination Path:</strong> <span id="stagingDestPath"></span></label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Current Path:</label>
                    <div class="input-group">
                        <span class="input-group-text">staging/</span>
                        <input type="text" class="form-control" id="currentStagingPath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="stagingUpBtn" onclick="navigateUpStaging()">
                            <i class="bi bi-arrow-up"></i> Up
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="refreshStaging()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Filter:</label>
                    <input type="text" class="form-control" id="stagingSearchInput" placeholder="Type to filter files..." oninput="renderStagingItems()">
                </div>
                <div id="stagingFilesList" style="max-height: 400px; overflow-y: auto;">
                    Loading...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Publish Modal -->
<div class="modal fade" id="bulkPublishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/deployments/bulk-publish" id="bulkPublishForm" onsubmit="return handleBulkPublishSubmit(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Publish to Cells</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="manifest" value="{{ manifest_name }}">
                    <input type="hidden" name="version" value="{{ version }}">
                    <input type="hidden" name="cells" id="selectedCellsInput" value="">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Publishing Version:</strong></label>
                        <div class="form-control-plaintext">
                            <code>{{ version }}</code>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Select Target Cells:</strong></label>
                        <div class="form-text mb-2">
                            <span class="spinner-border spinner-border-sm" role="status" id="cellsLoading" style="display:none;"></span>
                            <span id="cellsLoadingText" style="display:none;">Loading cells...</span>
                        </div>
                        <div id="cellsList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted">No cells available for this app.</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>Note:</strong> 
                        This will publish the deployment to all selected cells. 
                        Each cell will receive a copy of the version files and an updated trigger.json file.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="bulkPublishButton" disabled>
                        <i class="bi bi-rocket-takeoff"></i> Publish to Selected Cells
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Publish Pre-check Modal -->
<div class="modal fade" id="bulkPublishPrecheckModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clipboard-check"></i> Bulk Publish Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    You are about to publish <code>{{ version }}</code> to the selected cells.
                    This pre-check shows which cells will be <strong>rebuilt</strong> vs <strong>reused</strong>.
                </p>

                <div class="alert alert-info mb-3">
                    <strong>Rebuild</strong> = version snapshot does not exist in the cell yet → controller will build
                    <code>cells/&lt;node&gt;/&lt;cell&gt;/versions/{{ version }}/</code> (copy + merge overrides), then trigger.<br>
                    <strong>Reuse</strong> = version snapshot already exists → controller will not rebuild files, it will only
                    <strong>re-trigger</strong> the agent to re-apply/restart the existing snapshot.<br>
                    If you changed overrides and want a rebuild, delete the cell version first (or publish a new version).
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border rounded p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><span class="badge bg-primary">Rebuild</span> <span id="bulkRebuildCount">0</span></strong>
                            </div>
                            <div id="bulkRebuildList" style="max-height: 220px; overflow-y: auto;">
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><span class="badge bg-secondary">Reuse</span> <span id="bulkReuseCount">0</span></strong>
                            </div>
                            <div id="bulkReuseList" style="max-height: 220px; overflow-y: auto;">
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="bulkPrecheckConfirmBtn">
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let bulkPublishModal;
let bulkPublishPrecheckModal;
let selectedCells = new Set();
let bulkBypassPrecheck = false;

document.addEventListener('DOMContentLoaded', function() {
    bulkPublishModal = new bootstrap.Modal(document.getElementById('bulkPublishModal'));
    bulkPublishPrecheckModal = new bootstrap.Modal(document.getElementById('bulkPublishPrecheckModal'));
});

async function showBulkPublishModal() {
    const manifestName = '{{ manifest_name }}';
    
    // Show modal and loading state
    bulkPublishModal.show();
    document.getElementById('cellsLoading').style.display = 'inline-block';
    document.getElementById('cellsLoadingText').style.display = 'inline';
    document.getElementById('cellsList').innerHTML = '<p class="text-muted">Loading cells...</p>';
    document.getElementById('bulkPublishButton').disabled = true;
    
    try {
        // Get cells for the manifest
        const response = await fetch(`/api/app-cells?manifest=${encodeURIComponent(manifestName)}`);
        const cellsData = await response.json();
        
        document.getElementById('cellsLoading').style.display = 'none';
        document.getElementById('cellsLoadingText').style.display = 'none';
        
        if (cellsData.cells && cellsData.cells.length > 0) {
            selectedCells.clear();
            let html = '<div class="form-check mb-2">';
            html += '<input class="form-check-input" type="checkbox" id="selectAllCells" checked onchange="toggleAllCells(this.checked)">';
            html += '<label class="form-check-label" for="selectAllCells"><strong>Select All</strong></label>';
            html += '</div><hr>';
            
            cellsData.cells.forEach(cell => {
                selectedCells.add(cell.cell_key);
                html += `
                    <div class="form-check">
                        <input class="form-check-input cell-checkbox" type="checkbox" 
                               value="${cell.cell_key}" id="cell_${cell.cell_key.replace('/', '_')}" 
                               checked onchange="updateCellSelection()">
                        <label class="form-check-label" for="cell_${cell.cell_key.replace('/', '_')}">
                            <strong>${cell.cell_key}</strong>
                            <br><small class="text-muted">Bucket: ${cell.bucket}</small>
                        </label>
                    </div>
                `;
            });
            
            document.getElementById('cellsList').innerHTML = html;
            document.getElementById('bulkPublishButton').disabled = false;
        } else {
            document.getElementById('cellsList').innerHTML = '<p class="text-muted">No cells available for this app.</p>';
            document.getElementById('bulkPublishButton').disabled = true;
        }
    } catch (error) {
        console.error('Error loading cells:', error);
        document.getElementById('cellsLoading').style.display = 'none';
        document.getElementById('cellsLoadingText').style.display = 'none';
        document.getElementById('cellsList').innerHTML = '<p class="text-danger">Error loading cells. Please try again.</p>';
        document.getElementById('bulkPublishButton').disabled = true;
    }
}

function toggleAllCells(checked) {
    document.querySelectorAll('.cell-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
    });
    updateCellSelection();
}

function updateCellSelection() {
    const checkboxes = document.querySelectorAll('.cell-checkbox');
    const checkedCount = document.querySelectorAll('.cell-checkbox:checked').length;
    const totalCount = checkboxes.length;
    
    // Update "Select All" checkbox state
    const selectAllCheckbox = document.getElementById('selectAllCells');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = checkedCount === totalCount;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
    }
    
    // Enable/disable publish button
    document.getElementById('bulkPublishButton').disabled = checkedCount === 0;
    
    // Update button text
    const button = document.getElementById('bulkPublishButton');
    if (checkedCount > 0) {
        button.innerHTML = `<i class="bi bi-rocket-takeoff"></i> Publish to ${checkedCount} Cell${checkedCount > 1 ? 's' : ''}`;
    } else {
        button.innerHTML = `<i class="bi bi-rocket-takeoff"></i> Publish to Selected Cells`;
    }
}

function collectSelectedCells() {
    // Collect all checked cell values
    const selectedCells = Array.from(document.querySelectorAll('.cell-checkbox:checked'))
        .map(cb => cb.value);
    
    // Store as JSON in hidden field
    document.getElementById('selectedCellsInput').value = JSON.stringify(selectedCells);
    
    return true; // Allow form submission
}

async function handleBulkPublishSubmit(event) {
    // If user already confirmed, allow submission.
    if (bulkBypassPrecheck) {
        bulkBypassPrecheck = false;
        return true;
    }

    event.preventDefault();
    collectSelectedCells();

    const selected = document.getElementById('selectedCellsInput').value;
    const version = '{{ version }}';

    try {
        const resp = await fetch(`/api/cell-versions-exist?version=${encodeURIComponent(version)}&cells=${encodeURIComponent(selected)}`);
        const data = await resp.json();
        const results = (data.results || []);
        const rebuild = results.filter(r => !r.exists);
        const reuse = results.filter(r => r.exists);

        // Populate lists and show modal (always, so user sees both rebuild & reuse)
        document.getElementById('bulkRebuildCount').textContent = rebuild.length.toString();
        document.getElementById('bulkReuseCount').textContent = reuse.length.toString();

        const rebuildList = document.getElementById('bulkRebuildList');
        const reuseList = document.getElementById('bulkReuseList');
        rebuildList.innerHTML = rebuild.length ? '<ul class="mb-0 small"></ul>' : '<span class="text-muted small">None</span>';
        reuseList.innerHTML = reuse.length ? '<ul class="mb-0 small"></ul>' : '<span class="text-muted small">None</span>';

        if (rebuild.length) {
            const ul = rebuildList.querySelector('ul');
            rebuild.forEach(r => {
                const li = document.createElement('li');
                li.innerHTML = `<code>${r.cell_key}</code>`;
                ul.appendChild(li);
            });
        }

        if (reuse.length) {
            const ul = reuseList.querySelector('ul');
            reuse.forEach(r => {
                const li = document.createElement('li');
                li.innerHTML = `<code>${r.cell_key}</code>`;
                ul.appendChild(li);
            });
        }

        // Wire confirm button
        const btn = document.getElementById('bulkPrecheckConfirmBtn');
        btn.textContent = `Continue (rebuild ${rebuild.length}, reuse ${reuse.length})`;
        btn.onclick = () => {
            bulkPublishPrecheckModal.hide();
            bulkBypassPrecheck = true;
            document.getElementById('bulkPublishForm').submit();
        };

        bulkPublishPrecheckModal.show();
        return false;
    } catch (e) {
        // On error, fall back to native confirm.
        if (confirm('Pre-check failed. Continue publishing anyway?')) {
            bulkBypassPrecheck = true;
            document.getElementById('bulkPublishForm').submit();
        }
        return false;
    }
}
</script>
{% endblock %}

