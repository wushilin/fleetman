{% extends "base.html" %}

{% block title %}Cell Overrides: {{ node_id }}/{{ cell_id }} - Fleetman{% endblock %}

{% block nav_cells %}active{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="/cells" class="btn btn-secondary">&larr; Back to Cells</a>
</div>

<h1>Cell Overrides: <span class="text-primary">{{ node_id }}/{{ cell_id }}</span></h1>
<p class="text-muted">Bucket: <strong>{{ bucket }}</strong></p>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Override Files</h5>
    </div>
    <div class="card-body">
        {% if overrides.is_empty() %}
        <p class="text-muted">No override files defined yet.</p>
        {% else %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>File Path</th>
                        <th>Type</th>
                        <th>Meta</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in overrides %}
                    <tr>
                        <td><code>{{ file.path }}</code></td>
                        <td><span class="badge bg-secondary">{{ file.file_type }}</span></td>
                        <td>
                            {% if file.has_custom_meta %}
                                <span class="badge text-bg-secondary">{{ file.meta_str }}</span>
                            {% else %}
                                <span class="text-muted">default</span>
                            {% endif %}
                        </td>
                        <td>{% if file.is_folder %}-{% else %}{{ file.size }} bytes{% endif %}</td>
                        <td>{{ file.last_modified }}</td>
                        <td>
                            {% if file.file_type == "text" || file.file_type == "template" %}
                            <a href="/cells/{{ node_id }}/{{ cell_id }}/overrides/edit?file_path={{ file.path }}" 
                               class="btn btn-sm btn-primary">Edit</a>
                            {% else %}
                            <button type="button" class="btn btn-sm btn-secondary" disabled>Edit</button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-info"
                                    onclick="showEditMetaModal('{{ file.path }}', '{{ file.file_type }}', '{{ file.owner_str }}', '{{ file.group_str }}', '{{ file.mode_str }}')">
                                Customize
                            </button>
                            <form method="post" action="/cells/{{ node_id }}/{{ cell_id }}/overrides/delete" 
                                  style="display:inline;">
                                <input type="hidden" name="file_path" value="{{ file.path }}">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Are you sure you want to delete {{ file.path }}?');">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Add New Override File</h5>
    </div>
    <div class="card-body">
        <form method="post" action="/cells/{{ node_id }}/{{ cell_id }}/overrides/upload" 
              enctype="multipart/form-data" id="overrideForm" onsubmit="return validateOverridePath()">
            <div class="mb-3">
                <label for="file_path" class="form-label">File Path</label>
                <input type="text" class="form-control" id="file_path" name="file_path" 
                       required placeholder="config/app.conf or logs/" oninput="inferFileMetadata()">
                <div class="form-text">Path within the overrides folder (e.g., config/app.conf, myfile.txt, or logs/ for folder)</div>
                <div id="pathValidationError" class="text-danger small" style="display: none;"></div>
            </div>
            
            <div class="mb-3">
                <label for="file_type" class="form-label">File Type</label>
                <select class="form-control" id="file_type" name="file_type" onchange="updateFileTypeUI()">
                    <option value="text">Text</option>
                    <option value="template">Template</option>
                    <option value="binary">Binary</option>
                    <option value="folder">Folder</option>
                </select>
                <div class="form-text">Auto-detected based on path</div>
            </div>
            
            <div class="mb-3" id="sourceSection">
                <label class="form-label">Source</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="source_type" id="sourceUpload" 
                           value="upload" checked onchange="toggleSourceType()">
                    <label class="form-check-label" for="sourceUpload">
                        Upload from Computer
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="source_type" id="sourceStaging" 
                           value="staging" onchange="toggleSourceType()">
                    <label class="form-check-label" for="sourceStaging">
                        Copy from Staging
                    </label>
                </div>
            </div>
            
            <div class="mb-3" id="uploadSection">
                <label for="file" class="form-label">Select File</label>
                <input type="file" class="form-control" id="file" name="file">
            </div>
            
            <div class="mb-3" id="stagingSection" style="display: none;">
                <label class="form-label">Staging File</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="staging_path" name="staging_path" 
                           readonly placeholder="Click Browse to select...">
                    <button type="button" class="btn btn-outline-secondary" onclick="showOverrideStagingModal()">
                        <i class="bi bi-folder"></i> Browse Staging
                    </button>
                </div>
            </div>
            
            <!-- Optional customization. If omitted, defaults are applied at deploy time by FleetAgent. -->
            <input type="hidden" id="owner" name="owner" value="">
            <input type="hidden" id="group" name="group" value="">
            <input type="hidden" id="mode" name="mode" value="">
            <div class="mb-3">
                <label class="form-label">Meta</label>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openOverrideMetaModal('add')">
                        <i class="bi bi-sliders"></i> Customize
                    </button>
                    <div id="addMetaBadges"></div>
                    <span id="addMetaDefaultHint" class="text-muted">default</span>
                </div>
                <div class="form-text">
                    Defaults: <code>run.sh</code> and folders => <code>0700</code>, other files => <code>0600</code>. Owner/group inherit from the service owner/group.
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Add Override</button>
        </form>
    </div>
</div>

<!-- Staging Browser Modal -->
<div class="modal fade" id="overrideStagingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select File from Staging</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Path:</label>
                    <div class="input-group">
                        <span class="input-group-text">staging/</span>
                        <input type="text" class="form-control" id="overrideStagingPath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="overrideStagingUpBtn" onclick="navigateUpOverrideStaging()">
                            <i class="bi bi-arrow-up"></i> Up
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="refreshOverrideStaging()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Filter:</label>
                    <input type="text" class="form-control" id="overrideStagingSearchInput" 
                           placeholder="Type to filter files..." oninput="renderOverrideStagingItems()">
                </div>
                <div id="overrideStagingFilesList" style="max-height: 400px; overflow-y: auto;">
                    Loading...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Override Meta Customize Modal (shared for Add + Edit) -->
<div class="modal fade" id="overrideMetaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customize Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Override (format: <code>user:group:mode</code>, use <code>-</code> for default)</label>
                    <input type="text" class="form-control" id="overrideMetaInput" placeholder="-:-:0700">
                    <div class="form-text">Examples: <code>-:-:0700</code>, <code>steve:-:0700</code>, <code>-:-:-</code> (clears customization)</div>
                </div>
                <div id="overrideMetaError" class="alert alert-danger" style="display:none; margin-bottom:0;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyOverrideMetaFromModal()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Metadata Modal -->
<div class="modal fade" id="editMetaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Override Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/cells/{{ node_id }}/{{ cell_id }}/overrides/update-meta" id="editMetaForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">File Path</label>
                        <input type="text" class="form-control" id="editMetaPath" name="file_path" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editMetaFileType" class="form-label">File Type</label>
                        <select class="form-control" id="editMetaFileType" name="file_type">
                            <option value="text">Text</option>
                            <option value="binary">Binary</option>
                            <option value="folder">Folder</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Meta</label>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openOverrideMetaModal('edit')">
                                <i class="bi bi-sliders"></i> Customize
                            </button>
                            <div id="editMetaBadges"></div>
                            <span id="editMetaDefaultHint" class="text-muted">default</span>
                        </div>
                    </div>
                    <input type="hidden" id="editMetaOwner" name="owner" value="">
                    <input type="hidden" id="editMetaGroup" name="group" value="">
                    <input type="hidden" id="editMetaMode" name="mode" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let overrideStagingItems = [];
let overrideStagingPath = '';
let overrideStagingSortField = 'name';
let overrideStagingSortAsc = true;
const overrideBucket = '{{ bucket }}';

function validateOverridePathInput() {
    const path = document.getElementById('file_path').value.trim();
    const errorDiv = document.getElementById('pathValidationError');
    
    if (!path) {
        errorDiv.style.display = 'none';
        return true;
    }
    
    // Check for invalid patterns (allow trailing / for folders)
    if (path.startsWith('/') || path.startsWith('../') || path.startsWith('./') || 
        path.includes('/./') || path.includes('/../')) {
        errorDiv.textContent = 'Invalid path. Cannot use /, ../, ./, or path escape patterns. Use format: file.txt, folder/file.txt, or folder/';
        errorDiv.style.display = 'block';
        return false;
    }
    
    errorDiv.style.display = 'none';
    return true;
}

function inferFileMetadata() {
    validateOverridePathInput();
    
    const path = document.getElementById('file_path').value.trim();
    const fileTypeSelect = document.getElementById('file_type');
    
    if (!path) return;
    
    // Infer file type
    if (path.endsWith('/')) {
        // Folder
        fileTypeSelect.value = 'folder';
    } else if (path.match(/\.(sh|bash)$/)) {
        // Shell script
        fileTypeSelect.value = 'text';
    } else if (path.match(/\.(txt|conf|config|yml|yaml|json|xml|ini|properties|log|md|rst|csv)$/i)) {
        // Common text file extensions
        fileTypeSelect.value = 'text';
    } else {
        // Default to binary
        fileTypeSelect.value = 'binary';
    }
    
    updateFileTypeUI();
}

function updateFileTypeUI() {
    const fileType = document.getElementById('file_type').value;
    const sourceSection = document.getElementById('sourceSection');
    const uploadSection = document.getElementById('uploadSection');
    const stagingSection = document.getElementById('stagingSection');
    const sourceUpload = document.getElementById('sourceUpload');
    const sourceStaging = document.getElementById('sourceStaging');
    const fileInput = document.getElementById('file');
    
    if (fileType === 'folder') {
        // Hide entire source section for folders
        sourceSection.style.display = 'none';
        uploadSection.style.display = 'none';
        stagingSection.style.display = 'none';
        fileInput.required = false;
    } else {
        // Show source section for files
        sourceSection.style.display = 'block';
        
        // Show appropriate source section
        if (sourceUpload.checked) {
            uploadSection.style.display = 'block';
            stagingSection.style.display = 'none';
            fileInput.required = true;
        } else if (sourceStaging.checked) {
            uploadSection.style.display = 'none';
            stagingSection.style.display = 'block';
            fileInput.required = false;
        }
    }
}

function validateOverridePath() {
    if (!validateOverridePathInput()) {
        return false;
    }
    
    const fileType = document.getElementById('file_type').value;
    
    // Folders don't need file selection
    if (fileType === 'folder') {
        return true;
    }
    
    const sourceType = document.querySelector('input[name="source_type"]:checked').value;
    
    if (sourceType === 'upload') {
        const fileInput = document.getElementById('file');
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select a file to upload');
            return false;
        }
    } else if (sourceType === 'staging') {
        const stagingPath = document.getElementById('staging_path').value;
        if (!stagingPath) {
            alert('Please select a file from staging');
            return false;
        }
    }
    
    return true;
}

function toggleSourceType() {
    updateFileTypeUI();
}

function showOverrideStagingModal() {
    overrideStagingPath = '';
    overrideStagingSortField = 'name';
    overrideStagingSortAsc = true;
    document.getElementById('overrideStagingPath').value = '';
    document.getElementById('overrideStagingSearchInput').value = '';
    browseOverrideStagingFolder('');
    new bootstrap.Modal(document.getElementById('overrideStagingModal')).show();
}

function browseOverrideStagingFolder(path) {
    overrideStagingPath = path;
    document.getElementById('overrideStagingPath').value = path || '(root)';
    document.getElementById('overrideStagingUpBtn').disabled = !path;
    document.getElementById('overrideStagingSearchInput').value = '';
    
    const url = `/deployments/staging/browse?bucket=${encodeURIComponent(overrideBucket)}&path=${encodeURIComponent(path)}`;
    
    document.getElementById('overrideStagingFilesList').innerHTML = '<div class="alert alert-info">Loading...</div>';
    
    fetch(url)
        .then(r => {
            console.log('Staging browse response status:', r.status);
            return r.json();
        })
        .then(items => {
            console.log('Staging items received:', items);
            overrideStagingItems = items;
            renderOverrideStagingItems();
        })
        .catch(err => {
            console.error('Failed to load staging files:', err);
            document.getElementById('overrideStagingFilesList').innerHTML = 
                '<div class="alert alert-danger">Failed to load staging files: ' + err.message + '</div>';
        });
}

function navigateUpOverrideStaging() {
    if (!overrideStagingPath) return;
    const parts = overrideStagingPath.split('/');
    parts.pop();
    const parentPath = parts.join('/');
    browseOverrideStagingFolder(parentPath);
}

function refreshOverrideStaging() {
    browseOverrideStagingFolder(overrideStagingPath);
}

function sortOverrideStagingBy(field) {
    if (overrideStagingSortField === field) {
        overrideStagingSortAsc = !overrideStagingSortAsc;
    } else {
        overrideStagingSortField = field;
        overrideStagingSortAsc = true;
    }
    renderOverrideStagingItems();
}

function renderOverrideStagingItems() {
    const list = document.getElementById('overrideStagingFilesList');
    if (overrideStagingItems.length === 0) {
        list.innerHTML = '<div class="alert alert-info">No files or folders found in staging.</div>';
        return;
    }
    
    const searchTerm = (document.getElementById('overrideStagingSearchInput')?.value || '').toLowerCase().trim();
    let filtered = overrideStagingItems;
    if (searchTerm) {
        filtered = overrideStagingItems.filter(item => item.name.toLowerCase().includes(searchTerm));
    }
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="alert alert-warning">No files or folders match your filter.</div>';
        return;
    }
    
    const sorted = [...filtered].sort((a, b) => {
        if (a.is_folder !== b.is_folder) return a.is_folder ? -1 : 1;
        let aVal, bVal;
        if (overrideStagingSortField === 'name') {
            aVal = a.name.toLowerCase();
            bVal = b.name.toLowerCase();
        } else if (overrideStagingSortField === 'size') {
            aVal = a.size || 0;
            bVal = b.size || 0;
        } else if (overrideStagingSortField === 'modified') {
            aVal = a.last_modified || 0;
            bVal = b.last_modified || 0;
        }
        if (aVal < bVal) return overrideStagingSortAsc ? -1 : 1;
        if (aVal > bVal) return overrideStagingSortAsc ? 1 : -1;
        return 0;
    });
    
    let html = `<table class="table table-sm table-hover">
        <thead><tr>
            <th style="cursor: pointer;" onclick="sortOverrideStagingBy('name')">
                Name ${overrideStagingSortField === 'name' ? (overrideStagingSortAsc ? '▲' : '▼') : ''}
            </th>
            <th style="cursor: pointer;" onclick="sortOverrideStagingBy('size')">
                Size ${overrideStagingSortField === 'size' ? (overrideStagingSortAsc ? '▲' : '▼') : ''}
            </th>
            <th style="cursor: pointer;" onclick="sortOverrideStagingBy('modified')">
                Modified ${overrideStagingSortField === 'modified' ? (overrideStagingSortAsc ? '▲' : '▼') : ''}
            </th>
        </tr></thead><tbody>`;
    
    sorted.forEach(item => {
        const sizeStr = item.is_folder ? '-' : (item.size ? formatBytes(item.size) : 'N/A');
        const modifiedStr = item.is_folder ? '-' : (item.last_modified ? formatTimestamp(item.last_modified) : 'N/A');
        const icon = item.is_folder ? 'bi-folder' : 'bi-file-earmark';
        const nameDisplay = item.is_folder ? `${item.name}/` : item.name;
        const clickHandler = item.is_folder 
            ? `browseOverrideStagingFolder('${item.path}')`
            : `selectOverrideStagingFile('${item.path}')`;
        
        html += `<tr style="cursor: pointer;" onclick="${clickHandler}">
            <td><i class="bi ${icon}"></i> ${nameDisplay}</td>
            <td><small>${sizeStr}</small></td>
            <td><small>${modifiedStr}</small></td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    list.innerHTML = html;
}

function selectOverrideStagingFile(stagingPath) {
    document.getElementById('staging_path').value = stagingPath;
    bootstrap.Modal.getInstance(document.getElementById('overrideStagingModal')).hide();
}

function formatBytes(bytes) {
    if (bytes === null || bytes === undefined) return 'N/A';
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function formatTimestamp(timestamp) {
    if (!timestamp || timestamp === 'Unknown') return 'N/A';
    try {
        let date;
        if (typeof timestamp === 'number') {
            date = new Date(timestamp * 1000);
        } else if (typeof timestamp === 'string') {
            date = new Date(timestamp);
        } else {
            return 'N/A';
        }
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleString();
    } catch (e) {
        return 'N/A';
    }
}

let __overrideMetaContext = 'add'; // 'add' | 'edit'
let __restoreEditMetaModalAfterOverrideMeta = false;

function metaTripletString(owner, group, mode) {
    const o = owner && owner.trim() !== '' ? owner.trim() : '-';
    const g = group && group.trim() !== '' ? group.trim() : '-';
    const m = mode && mode.trim() !== '' ? mode.trim() : '-';
    return `${o}:${g}:${m}`;
}

function validateMetaToken(kind, v) {
    if (v === '-' || v === '') return null;
    if (/\s/.test(v)) return `${kind} cannot contain whitespace.`;
    if (v.includes(':')) return `${kind} cannot contain ':'.`;
    return null;
}

function normalizeModeToken(v) {
    if (v === '-' || v === '') return '';
    if (!/^[0-7]{3,4}$/.test(v)) return null;
    return v.length === 3 ? '0' + v : v;
}

function openOverrideMetaModal(context) {
    __overrideMetaContext = context;
    const err = document.getElementById('overrideMetaError');
    err.style.display = 'none';

    const owner = (context === 'edit' ? document.getElementById('editMetaOwner').value : document.getElementById('owner').value) || '';
    const group = (context === 'edit' ? document.getElementById('editMetaGroup').value : document.getElementById('group').value) || '';
    const mode = (context === 'edit' ? document.getElementById('editMetaMode').value : document.getElementById('mode').value) || '';

    document.getElementById('overrideMetaInput').value = metaTripletString(owner, group, mode);

    // If we're opening this from inside the edit modal, hide the parent first to avoid z-index/backdrop issues.
    __restoreEditMetaModalAfterOverrideMeta = false;
    if (context === 'edit') {
        const editEl = document.getElementById('editMetaModal');
        const editInst = bootstrap.Modal.getInstance(editEl);
        if (editInst) {
            __restoreEditMetaModalAfterOverrideMeta = true;
            editInst.hide();
        }
    }

    new bootstrap.Modal(document.getElementById('overrideMetaModal')).show();
}

function applyOverrideMetaFromModal() {
    const raw = (document.getElementById('overrideMetaInput').value || '').trim();
    const err = document.getElementById('overrideMetaError');
    err.style.display = 'none';

    const parts = raw.split(':');
    if (parts.length !== 3) {
        err.textContent = 'Invalid format. Expected: user:group:mode (use - for default).';
        err.style.display = 'block';
        return;
    }

    const ownerRaw = parts[0].trim() || '-';
    const groupRaw = parts[1].trim() || '-';
    const modeRaw = parts[2].trim() || '-';

    const ownerErr = validateMetaToken('Owner', ownerRaw);
    const groupErr = validateMetaToken('Group', groupRaw);
    const modeNorm = normalizeModeToken(modeRaw);
    if (ownerErr || groupErr || modeNorm === null) {
        err.textContent = ownerErr || groupErr || 'Invalid mode. Must be octal like 0700 or 700, or - for default.';
        err.style.display = 'block';
        return;
    }

    const ownerOut = ownerRaw === '-' ? '' : ownerRaw;
    const groupOut = groupRaw === '-' ? '' : groupRaw;
    const modeOut = modeRaw === '-' ? '' : modeNorm;

    if (__overrideMetaContext === 'edit') {
        document.getElementById('editMetaOwner').value = ownerOut;
        document.getElementById('editMetaGroup').value = groupOut;
        document.getElementById('editMetaMode').value = modeOut;
        renderOverrideMetaBadges('edit');
    } else {
        document.getElementById('owner').value = ownerOut;
        document.getElementById('group').value = groupOut;
        document.getElementById('mode').value = modeOut;
        renderOverrideMetaBadges('add');
    }

    bootstrap.Modal.getInstance(document.getElementById('overrideMetaModal'))?.hide();
}

function clearOverrideMeta(context) {
    if (context === 'edit') {
        document.getElementById('editMetaOwner').value = '';
        document.getElementById('editMetaGroup').value = '';
        document.getElementById('editMetaMode').value = '';
    } else {
        document.getElementById('owner').value = '';
        document.getElementById('group').value = '';
        document.getElementById('mode').value = '';
    }
    renderOverrideMetaBadges(context);
}

function renderOverrideMetaBadges(context) {
    const owner = (context === 'edit' ? document.getElementById('editMetaOwner').value : document.getElementById('owner').value) || '';
    const group = (context === 'edit' ? document.getElementById('editMetaGroup').value : document.getElementById('group').value) || '';
    const mode = (context === 'edit' ? document.getElementById('editMetaMode').value : document.getElementById('mode').value) || '';
    const any = owner.trim() !== '' || group.trim() !== '' || mode.trim() !== '';

    const badges = document.getElementById(context === 'edit' ? 'editMetaBadges' : 'addMetaBadges');
    const hint = document.getElementById(context === 'edit' ? 'editMetaDefaultHint' : 'addMetaDefaultHint');
    if (!badges) return;
    badges.innerHTML = '';

    if (!any) {
        if (hint) hint.style.display = '';
        return;
    }
    if (hint) hint.style.display = 'none';

    const span = document.createElement('span');
    span.className = 'badge text-bg-secondary';
    span.textContent = metaTripletString(owner, group, mode);
    const x = document.createElement('button');
    x.type = 'button';
    x.className = 'btn btn-sm btn-link text-light text-decoration-none ms-2 p-0';
    x.textContent = '×';
    x.onclick = () => clearOverrideMeta(context);
    span.appendChild(x);
    badges.appendChild(span);
}

function showEditMetaModal(path, fileType, owner, group, mode) {
    owner = owner || '';
    group = group || '';
    mode = mode || '';

    document.getElementById('editMetaPath').value = path;
    document.getElementById('editMetaFileType').value = fileType;
    document.getElementById('editMetaOwner').value = owner;
    document.getElementById('editMetaGroup').value = group;
    document.getElementById('editMetaMode').value = mode;
    renderOverrideMetaBadges('edit');
    new bootstrap.Modal(document.getElementById('editMetaModal')).show();
}

// Initialize badges on page load.
document.addEventListener('DOMContentLoaded', function() {
    renderOverrideMetaBadges('add');

    // When the override meta modal closes, restore the edit modal if we opened from there.
    const overrideEl = document.getElementById('overrideMetaModal');
    if (overrideEl) {
        overrideEl.addEventListener('hidden.bs.modal', function() {
            if (__restoreEditMetaModalAfterOverrideMeta) {
                __restoreEditMetaModalAfterOverrideMeta = false;
                new bootstrap.Modal(document.getElementById('editMetaModal')).show();
            }
        });
    }
});
</script>

<div class="alert alert-info mt-4">
    <h6>About Cell Overrides</h6>
    <p class="mb-0">
        Override files are cell-specific customizations that replace or supplement 
        the default deployment files. When a deployment is published to this cell, 
        these override files will be used by the fleetagent instead of the 
        default files from the deployment package.
    </p>
</div>

{% endblock %}

